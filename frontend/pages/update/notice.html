<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Notice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.06);
        }

        .header {
            text-align: center;
            padding: 40px 20px 20px;
            background: white;
        }

        .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        h1 {
            color: #1a1a1a;
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #6b7280;
            font-size: 15px;
            font-weight: 400;
        }

        .info-banner {
            background: #e0f2fe;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 20px 20px 30px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .info-icon {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: white;
            font-size: 12px;
            font-weight: bold;
            margin-top: 1px;
        }

        .info-text {
            color: #1e40af;
            font-size: 14px;
            line-height: 1.5;
        }

        .notices-section {
            padding: 0 20px 30px;
            background: white;
        }

        .section-title {
            color: #1f2937;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .notice-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            margin-bottom: 30px;
        }

        .notice-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .notice-table th {
            background: #f9fafb;
            color: #6b7280;
            font-weight: 600;
            padding: 12px 14px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e7eb;
        }

        .notice-table td {
            padding: 12px 14px;
            color: #374151;
            font-size: 14px;
            border-bottom: 1px solid #f3f4f6;
        }

        .notice-table tbody tr {
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .notice-table tbody tr:hover {
            background: #f9fafb;
        }

        .notice-table tbody tr:last-child td {
            border-bottom: none;
        }

        .form-container {
            padding: 0 20px 40px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #374151;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .label-icon {
            font-size: 16px;
        }

        .required {
            color: #ef4444;
            margin-left: 2px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px 14px;
            background: white;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            color: #1f2937;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        input[type="text"]::placeholder,
        input[type="number"]::placeholder {
            color: #9ca3af;
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
            padding-right: 40px;
        }

        .selected-course {
            background: #f3f4f6;
            padding: 10px 14px;
            border-radius: 6px;
            color: #374151;
            margin-top: 8px;
            font-size: 14px;
            border: 1px solid #e5e7eb;
        }

        .btn {
            width: 100%;
            background: #3b82f6;
            color: white;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
        }

        .btn:hover {
            background: #2563eb;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .response-section {
            padding: 30px 20px;
            background: #fafafa;
        }

        .response-box {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            color: #374151;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #6b7280;
        }

        @media (max-width: 768px) {
            .container {
                box-shadow: none;
            }

            h1 {
                font-size: 28px;
            }

            .notice-table {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="icon">üìù</div>
            <h1>Update Notice</h1>
            <p class="subtitle">Modify existing announcements</p>
        </div>

        <div class="info-banner">
            <div class="info-icon">i</div>
            <div class="info-text">Click on a notice from the table below to edit it</div>
        </div>

        <div class="notices-section">
            <h3 class="section-title">All Notices</h3>
            <div id="noticeTable"></div>
        </div>

        <div class="form-container">
            <h3 class="section-title">Edit Notice Details</h3>
            
            <div class="form-group">
                <label>
                    <span class="label-icon">üÜî</span>
                    Notice ID
                    <span class="required">*</span>
                </label>
                <input type="number" id="notice_id" placeholder="Enter notice ID">
            </div>

            <div class="form-group">
                <label>
                    <span class="label-icon">‚úèÔ∏è</span>
                    Title
                    <span class="required">*</span>
                </label>
                <input type="text" id="title" placeholder="Enter notice title">
            </div>

            <div class="form-group">
                <label>
                    <span class="label-icon">üìù</span>
                    Content
                    <span class="required">*</span>
                </label>
                <input type="text" id="content" placeholder="Write notice content here...">
            </div>

            <div class="form-group">
                <label>
                    <span class="label-icon">üéì</span>
                    Target Batch
                    <span class="required">*</span>
                </label>
                <input type="text" id="target_batch" placeholder="e.g. 2025">
            </div>

            <div class="form-group">
                <label>
                    <span class="label-icon">üìö</span>
                    Target Program
                    <span class="required">*</span>
                </label>
                <input type="text" id="target_program" placeholder="Enter program name">
            </div>

            <div class="form-group">
                <label>
                    <span class="label-icon">üìñ</span>
                    Course
                    <span class="required">*</span>
                </label>
                <select id="courseDropdown">
                    <option>Loading...</option>
                </select>
                <div id="selectedCourse"></div>
            </div>

            <input type="hidden" id="course_id">

            <button class="btn" onclick="updateNotice()">Update Notice</button>
        </div>

        <div class="response-section">
            <h3 class="section-title">Response</h3>
            <pre class="response-box" id="responseBox">Response will appear here...</pre>
        </div>
    </div>

    <script>
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getAuthToken()}`
            };
        }

        async function checkAuth() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = 'teacher_login.html';
                return null;
            }

            const response = await fetch(`http://127.0.0.1:8000/api/v1/me`, {
                headers: getAuthHeaders()
            });

            const user = await response.json();
            return user;
        }

        async function getNotice() {
            const url = `http://127.0.0.1:8000/api/v1/notices/`;
            
            document.getElementById("noticeTable").innerHTML = '<div class="loading">Loading notices...</div>';

            try {
                const response = await fetch(url, {
                    method: "GET",
                    headers: getAuthHeaders()
                });

                const notices = await response.json();
                renderNoticeTable(notices);

            } catch (error) {
                document.getElementById("noticeTable").innerHTML =
                    '<div class="empty-state"><p style="color:#ef4444">Error loading notices</p></div>';
            }
        }

        function renderNoticeTable(records) {
            if (!Array.isArray(records) || records.length === 0) {
                document.getElementById("noticeTable").innerHTML =
                    '<div class="empty-state"><p>No notices found.</p></div>';
                return;
            }

            let table = `
                <div class="notice-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Content</th>
                                <th>Batch</th>
                                <th>Program</th>
                                <th>Course</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            records.forEach(n => {
                table += `
                    <tr onclick="fillNoticeForm(${JSON.stringify(n).replace(/"/g, '&quot;')})">
                        <td>${n.id}</td>
                        <td>${n.title}</td>
                        <td>${n.content}</td>
                        <td>${n.target_batch}</td>
                        <td>${n.target_program}</td>
                        <td>${n.course_id || 'N/A'}</td>
                    </tr>
                `;
            });

            table += `
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById("noticeTable").innerHTML = table;
        }

        function fillNoticeForm(notice) {
            document.getElementById('notice_id').value = notice.id;
            document.getElementById('title').value = notice.title;
            document.getElementById('content').value = notice.content;
            document.getElementById('target_batch').value = notice.target_batch;
            document.getElementById('target_program').value = notice.target_program;
            if (notice.course_id) {
                document.getElementById('course_id').value = notice.course_id;
            }
        }

        window.onload = getNotice;

        async function loadCourses() {
            const user = await checkAuth();
            const dropdown = document.getElementById("courseDropdown");

            if (!user) return;

            try {
                const response = await fetch(`http://127.0.0.1:8000/api/v1/teachers/${user.id}/courses`, {
                    headers: getAuthHeaders()
                });

                const courses = await response.json();
                dropdown.innerHTML = "";

                courses.forEach(course => {
                    const option = document.createElement("option");
                    option.value = course.id;
                    option.textContent = course.name;
                    dropdown.appendChild(option);
                });

            } catch (error) {
                dropdown.innerHTML = "<option>Error loading courses</option>";
            }
        }

        document.getElementById("courseDropdown").addEventListener("change", (e) => {
            const selectedId = e.target.value;
            const selectedText = e.target.options[e.target.selectedIndex].text;

            document.getElementById("selectedCourse").innerHTML =
                `<div class="selected-course"><b>Selected:</b> ${selectedText} (ID: ${selectedId})</div>`;

            document.getElementById("course_id").value = selectedId;
        });

        loadCourses();

        async function updateNotice() {
            const noticeId = document.getElementById("notice_id").value;
            const title = document.getElementById("title").value;
            const content = document.getElementById("content").value;
            const targetBatch = document.getElementById("target_batch").value;
            const targetProgram = document.getElementById("target_program").value;
            const courseId = document.getElementById("course_id").value;

            const token = getAuthToken();

            if (!noticeId) {
                document.getElementById("responseBox").textContent =
                    "Error: notice_id is required.";
                return;
            }

            document.getElementById("responseBox").textContent = "Updating notice...";

            const url = `http://127.0.0.1:8000/api/v1/notices/${noticeId}`;

            const bodyData = {
                title: title,
                content: content,
                target_batch: targetBatch,
                target_program: targetProgram,
                course_id: courseId ? Number(courseId) : null
            };

            try {
                const response = await fetch(url, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify(bodyData)
                });

                const json = await response.json();
                document.getElementById("responseBox").innerHTML =
                    JSON.stringify(json, null, 2);

            } catch (error) {
                document.getElementById("responseBox").innerHTML =
                    "Error: " + error.message;
            }
        }
    </script>
</body>
</html>